<head>
    <style> body {
        margin: 0;
    } </style>

    <script src="https://unpkg.com/three@0.136.0/build/three.js"></script>
    <script src="https://unpkg.com/three@0.136.0/examples/js/controls/TrackballControls.js"></script>

    <script src="three-forcegraph.js"></script>
    <!--<script src="../../dist/three-forcegraph.js"></script>-->
</head>

<body>
<div id="3d-graph"></div>

<script>
    // Gen random data
    let failureLinkOpacity = 0.5;
    let failureNodeOpacity = 0.85;
    const N = 30;
    let numberOfHistoryNodes = 15;
    const gData = {
        nodes: [...Array(N).keys()].map(i => ({
            id: i,
            timestamp: 0,
            neighbours: [],
            history: [],
            color: "#81c95f",
            opacity: 0.75
        })),
        links: [...Array(N).keys()]
            .filter(id => id)
            .map(id => ({
                source: id,
                target: Math.round(Math.random() * (id - 1)),
                active: true,
                color: "#81c95f",
                timestamp: 0,
                opacity: 0.2
            }))
    };
    gData.links.forEach(link => {
        gData.nodes[link.source].neighbours.push(link.target);
    })
    let numberOfNodes = gData.nodes.length;
    for (let i = 0; i < numberOfNodes; i++) {
        let failureMultiplier = 1.0
        for (let j = 1; j <= numberOfHistoryNodes; j++) {
            let nodeId = (i + 1) * 10000 + j;
            let isActive = Math.random() < 0.99 * failureMultiplier;
            if (!isActive) {
                failureMultiplier *= 0.9;
            }
            let node = {
                id: nodeId,
                timestamp: j,
                neighbours: [],
                history: [],
                active: isActive,
                color: isActive ? "#81c95f" : "#FF0000",
                opacity: isActive ? 0.75 : failureNodeOpacity
            };
            gData.nodes.push(node);
            gData.nodes[i].history.push(node);
        }
    }
    for (let i = 0; i < numberOfNodes; i++) {
        for (let j = 1; j <= numberOfHistoryNodes; j++) {
            let nodeId = (i + 1) * 10000 + j;
            for (let k = 0; k < gData.nodes[i].neighbours.length; k++) {
                let sourceNode = getNodeWithId(nodeId);
                let targetNode = getNodeWithId((gData.nodes[i].neighbours[k] + 1) * 10000 + j)
                gData.links.push({
                    source: sourceNode,
                    target: targetNode,
                    timestamp: j,
                    active: sourceNode.active,
                    color: sourceNode.active ? "#81c95f" : "#FF0000",
                    opacity: failureLinkOpacity
                })
            }
        }
    }

    function getNodeWithId(id) {
        return gData.nodes.filter(node => node.id === id)[0];
    }

    console.log(gData);

    const Graph = new ThreeForceGraph()
        .linkOpacity(0.25)
        .linkWidth(2)
        .graphData(gData);
    Graph.numDimensions(2)

    // Setup renderer
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('3d-graph').appendChild(renderer.domElement);

    // Setup scene
    const scene = new THREE.Scene();
    scene.add(Graph);
    scene.add(new THREE.AmbientLight(0xbbbbbb));

    // Setup camera
    const camera = new THREE.PerspectiveCamera();
    camera.far = 10000;
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    camera.lookAt(Graph.position);
    camera.position.z = Math.cbrt(N) * 180;

    // Add camera controls
    const tbControls = new THREE.TrackballControls(camera, renderer.domElement);

    // Kick-off renderer
    (function animate() { // IIFE
        Graph.tickFrame();

        // Frame cycle
        tbControls.update();
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
    })();
</script>
</body>