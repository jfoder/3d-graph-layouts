<head>
    <style> body {
        margin: 0;
    } </style>

    <script src="https://unpkg.com/three@0.136.0/build/three.js"></script>
    <script src="https://unpkg.com/three@0.136.0/examples/js/controls/TrackballControls.js"></script>

    <script src="three-forcegraph.js"></script>
    <!--<script src="../../dist/three-forcegraph.js"></script>-->
</head>

<body>
<div id="3d-graph"></div>

<script>
    // Gen random data
    const N = 300;
    let gData = {nodes: [], links: []};
    generateTreeGraph(0, 2, gData, -1, 'first');
    console.log(gData);


    const Graph = new ThreeForceGraph()
        .d3AlphaDecay(0.02)
        .d3VelocityDecay(0.6)
        .graphData(gData)
        .cooldownTime(4000)
        .linkDirectionalArrowLength(2)
        .linkDirectionalArrowRelPos(1)
        .nodeOpacity(0.3);
    Graph.numDimensions(3)

    // Setup renderer
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('3d-graph').appendChild(renderer.domElement);

    // Setup scene
    const scene = new THREE.Scene();
    scene.add(Graph);
    scene.add(new THREE.AmbientLight(0xbbbbbb));

    // Setup camera
    const camera = new THREE.PerspectiveCamera();
    camera.far = 10000;
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    camera.lookAt(Graph.position);
    camera.position.z = Math.cbrt(N) * 180;

    // Add camera controls
    const tbControls = new THREE.TrackballControls(camera, renderer.domElement);

    // Kick-off renderer
    (function animate() { // IIFE
        Graph.tickFrame();

        // Frame cycle
        tbControls.update();
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
    })();


    function generateTreeGraph(currentLevel, maxLevel, graph, parentId, label) {
        if (typeof generateTreeGraph.currentId == 'undefined') {
            generateTreeGraph.currentId = 0;
        }

        if (currentLevel > maxLevel) {
            return;
        }

        let numberOfChildren = currentLevel === 0 ? 50 : getRandomIntInclusive(10, 30);

        let node = {
            id: ++(generateTreeGraph.currentId),
            label: label,
            main: true,
            color: currentLevel === 1 ? "#2dffc8" : "#006dff",
            level: currentLevel
        };
        graph.nodes.push(node)
        if (currentLevel !== 0 && Math.random() <= 0.25) {
            let numberOfSameLabelChildren = getRandomIntInclusive(1, 3) * 2;
            for (let i = 1; i <= numberOfSameLabelChildren; i++) {
                let node = {
                    id: ++(generateTreeGraph.currentId),
                    label: label,
                    main: false,
                    color: currentLevel === 1 ? "#2dffc8" : "#006dff",
                    level: currentLevel
                }
                graph.nodes.push(node);
                graph.links.push({
                    source: parentId,
                    target: node.id
                })
            }
        }
        if (currentLevel !== 0) {
            graph.links.push({
                source: parentId,
                target: node.id
            })
        }
        for (let i = 1; i <= numberOfChildren; i++) {
            let childLabel = Math.random().toString();
            generateTreeGraph(currentLevel + 1, maxLevel, graph, node.id, childLabel);
        }
    }

    function getRandomIntInclusive(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
</script>
</body>